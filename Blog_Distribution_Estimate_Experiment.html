<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oTree Interactive Graph - Code Explanation</title>

    <!-- Include Prism.js CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">

    <!-- Include Prism.js JavaScript for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>

</head>

<!-- Navigation Bar -->


<body>

<header class="main-header">
    <h1>Interactive Taxation Voting, Code Explanation</h1>
</header>

   <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="expectations-redistribution.html">Job Market Paper</a></li>
            <li>
                <a href="#">Research</a>
                <ul>
                    <li><a href="research.html">Overview</a></li>
                    <li><a href="altruism-self-deception.html">Altruism and Self-Deception</a></li>
                    <li><a href="social-image-project-choice.html">Project Choice and Social Image</a></li>
                    <li><a href="expectations-redistribution.html">Expectations and Redistribution</a></li>
                    <li><a href="parenthood-imputation.html">Imputing Parenthood Status</a></li>
                </ul>
            </li>
            <li><a href="Courses.html">Teaching</a></li>
            <li>
                <a href="#">oTree Tutorials</a>
                <ul>
                    <li><a href="tutorials.html">Motivation</a></li>
                    <li><a href="Blog_Taxation_Experiment.html">Interactive Taxation Tutorial</a></li>
                    <li><a href="Blog_Distribution_Estimate_Experiment.html">Estimating Distributions Tutorial</a></li>
                </ul>
            </li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
        <!-- Mobile-only profile image positioned next to navigation -->
        <div class="mobile-profile-img-container">
            <img src="images/theodoros-2.jpg" alt="Theodoros Saroglou" class="profile-img">
        </div>
    </nav>

 <div class="container">

 <p style="font-size:20px; text-align: left;">Despite receiving various pieces of information and signals, some participants
 might not have a clear picture of what the income distribution is. Perception is often more important than reality, and in some experimental economics contexts, we need to assess whether these perceptions do indeed match reality.</p>
           <p style="font-size:20px; text-align: left;">Asking participants to report their perceived inequality level can be tricky, to improve on this measurement I constructed the interactive graph below. Participants can adjust the slope, curvature, and overall height of the bars through three sliders. This approach is more interactive and visual and could possibly result in more accurate responses </p>

        <p style="font-size:20px; text-align: left;"> You can test the example below before moving on to learning how to apply it in your experiments. </p>



    </div>



<body>

    <!-- Interactive section inside a box -->
    <div class="container">
        <div class="experiment-box">
                <!-- Interactive Graph -->
                <div class="histogram-wrapper">
                    <div class="histogram-title">Adjust the Distribution</div>
                    <div class="histogram-container" id="interactiveHistogram">
                        <!-- 10 bars -->
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                        <div class="bar">
                            <div class="bar-graph" style="height: 80px;">
                                <span class="score-value">2</span>
                                <span class="money-earned">€0.33</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slider Inputs -->
                <div class="sliders-container">
                    <p>Adjust Slope</p>
                    <input type="range" class="slider" id="slopeSlider" min="0" max="10" step="1" value="0">
                    <p>Adjust Curvature</p>
                    <input type="range" class="slider" id="curveSlider" min="0" max="20" step="1" value="0">
                    <p>Adjust Overall Height</p>
                    <input type="range" class="slider" id="heightSlider" min="0" max="15" step="1" value="2">
                </div>

                <!-- Submit Button -->
                <button class="btn" id="submitButton">Submit</button>

        </div>
    </div>

     <script>
        document.addEventListener('DOMContentLoaded', function () {
            const bars = document.querySelectorAll('#interactiveHistogram .bar-graph');
            const heightSlider = document.getElementById('heightSlider');
            const slopeSlider = document.getElementById('slopeSlider');
            const curveSlider = document.getElementById('curveSlider');
            const submitButton = document.getElementById('submitButton');
            const maxScore = 15;

            function updateBars() {
                const baseScore = parseInt(heightSlider.value);
                const slope = slopeSlider.value / 10;
                const curvature = curveSlider.value / 10;
                const numBars = bars.length;

                bars.forEach((bar, index) => {
                    const positionFactor = index / (numBars - 1);
                    const curveFactor = Math.pow(positionFactor, 1 + curvature * 2);
                    let newScore = baseScore + slope * positionFactor * maxScore * curveFactor;
                    newScore = Math.max(0, Math.min(newScore, maxScore));
                    const newHeightPx = (newScore / maxScore) * 330 + 35; // Adjust max height scaling
                    bar.style.height = `${newHeightPx}px`;

                    const scoreValue = bar.querySelector('.score-value');
                    scoreValue.innerText = newScore.toFixed(0);

                    const moneyEarned = bar.querySelector('.money-earned');
                    const moneyValue = (newScore / maxScore * 2.5).toFixed(2);
                    moneyEarned.innerText = `€${moneyValue}`;
                });
            }

            updateBars();

            heightSlider.addEventListener('input', updateBars);
            slopeSlider.addEventListener('input', updateBars);
            curveSlider.addEventListener('input', updateBars);
        });
    </script>

</head>

<div class="download-buttons">
    <a href="python_code_distribution.py" download="python_code_distribution.py">Download Python Code</a>
    <a href="html_code_distribution" download="html_code_distribution">Download HTML/Java Code</a>
</div>
<br>

<!-- Step 1: Python Code Initialization -->
<div class="code-section">
   <div class="explanation">
    <h2>Step 1: Defining the oTree Page Class  (Python)</h2>
    <p>This code defines a page class in oTree. The `form_model` refers to the player model, and the `form_fields` list specifies the fields that will be included in the form (in this case, 'adjustment_values'). The `is_displayed` function determines if the page should be shown to the player, based on whether they have given consent and haven't been removed.</p>
</div>
    <div class="code-snippet">
        <pre class="language-python"><code class="language-python">
class SecondTaxRateVoting(Page):
    form_model = 'player'
    form_fields = ['adjustment_values']

    def is_displayed(player):
        return player.consent and not player.remove
        </code></pre>
    </div>
</div>

<!-- Step 2: Processing Player Data -->
<div class="code-section">
   <div class="explanation">
    <h2>Step 2: Preparing Data for the Graph  (Python)</h2>
    <p>This function prepares data for use in the HTML template.
        It gathers players from the opposite group and sorts them based on
        their `test_score2` values. It returns the number of bars (players) to
        be displayed in the graph, which corresponds to the players from the opposite group.</p>
       <p>You don't need to perform this extensive sorting, the important part here is to create a
           variable that holds the participants in the other group so we can match the number of bars
       we want to display. If you want to have a fixed number of bars, no sorting is needed.
           Nevertheless, keeping the sorting can be useful if you'd like to reveal the distribution to
       participants at some point in the page (see redistribution tutorial).</p>
</div>
    <div class="code-snippet">
        <pre class="language-python"><code class="language-python">
def vars_for_template(player: Player):
    current_player = player
    player_group_type = current_player.group_type

    # Get the players from the opposite group and filter out players with None test_score2
    opposite_group_players = sorted(
        [p for p in player.group.get_players() if
         p.group_type != player_group_type and p.field_maybe_none('test_score2') is not None],
        key=lambda p: p.field_maybe_none('test_score2')
    )

    num_bars = len(opposite_group_players)

    # Create the predefined distribution for the interactive graph (using integers from 0 to 15)


    return {
        'num_bars': num_bars  # Send the number of sliders needed
    }
            </code></pre>
    </div>
</div>

<!-- Step 3: Assigning Colors and Handling Timeout -->
<div class="code-section">
 <div class="explanation">
    <h2>Step 3: Handling Adjustments and Timeout  (Python)</h2>
    <p>This function handles player actions before moving to the next page.
        It processes the player's adjustments, checks for errors, and handles timeout scenarios.
        In this case, if the player times out, their timeout count is incremented,
        and if they reach three timeouts,
        they are removed from the experiment.</p>

     <p>Note that adjustment values are lists of numbers which you can later use to perform calculations, such as finding the GINI coefficient, that allow for comparison between participants.</p>
</div>
    <div class="code-snippet">
        <pre class="language-python"><code class="language-python">
def before_next_page(player: Player, timeout_happened):
    # Handle adjustments only if there's no timeout
    if not timeout_happened:
        try:
            # Convert the comma-separated string back into a list of floats
            adjustment_values = [float(value) for value in player.adjustment_values.split(',')]
        except ValueError:
            player.participant.vars['adjustment_error'] = True
            return

        # Check if the length of adjustment values matches the number of players
        opposite_group_players = [p for p in player.group.get_players() if p.group_type != player.group_type]
        if len(adjustment_values) != len(opposite_group_players):
            player.participant.vars['adjustment_error'] = True
        else:
            player.participant.vars['adjustment_error'] = False

    # Handle the timeout scenario
    if timeout_happened:
        # Increment the timeout count stored in participant.vars
        player.timeout_count += 1

        # If the participant times out 3 times, mark them for exclusion
        if player.timeout_count >= 3:
            player.remove = True  # Mark player for removal
            </code></pre>
    </div>
    </div>

      <!-- Step 4: HTML Structure for Graph -->
    <div class="code-section">
       <div class="explanation">
    <h2>Step 4: Structuring the HTML for the Graph (HTML)</h2>
    <p>This block defines the basic structure and style of the histogram for the interactive graph.
        It includes the title and wrapper for the graph, which will later hold the dynamically generated bars
        This is only a short sample of the styles, there are many others you should include. You can always use a .css file instead. If you would like to see all styles, you can download the corresponding HTML code through the button above. </p>
</p>
</div>
        <div class="code-snippet">
                      <pre class="language-html"><code class="language-html">

&lt;style&gt;
   body {
        font-family: 'Arial', sans-serif;
        background-color: #f5f5f5;
        color: #333;
    }


    .histogram-wrapper {
        width: 100%;
        height: auto;
    }

    .histogram-title {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: #0056b3;
    }
&lt;/style&gt;

            </code></pre>
        </div>
    </div>

     <!-- Step 5: Dynamic Bar Graph -->
    <div class="code-section">
        <div class="explanation">
    <h2>Step 5: Creating the Dynamic Bar Graph  (HTML)</h2>
    <p>This HTML section defines the structure of the dynamic bar graph. It includes sliders for adjusting slope, curvature, and height, as well as a container for the bars representing each player's score. The bars' heights will be dynamically updated based on player scores. The dynamic relationship is specified in the Javascript below.</p>
</div>
        <div class="code-snippet">
            <pre class="language-html"><code class="language-html">

&lt;!-- Interactive section --&gt;
&lt;div class="sliders-container"&gt;
    &lt;p&gt;Adjust Slope&lt;/p&gt;
    &lt;input type="range" id="slopeSlider" class="slider" min="0" max="10" step="1" value="0"&gt;
    &lt;p&gt;Adjust Curvature&lt;/p&gt;
    &lt;input type="range" id="curveSlider" class="slider" min="0" max="20" step="1" value="0"&gt;
    &lt;p&gt;Adjust Overall Height&lt;/p&gt;
    &lt;input type="range" id="heightSlider" class="slider" min="0" max="15" step="1" value="2"&gt;
&lt;/div&gt;

&lt;div class="histogram-wrapper"&gt;
    &lt;div class="histogram-container" id="interactiveHistogram"&gt;
        &lt;div class="horizontal-line"&gt;&lt;/div&gt;
        {% for value in predefined_distribution %}
        &lt;div class="bar" style="flex: 1 1 calc((100% / {{ predefined_distribution|length }}) - 4px);"&gt;
            &lt;div class="bar-graph" style="height: {{ value.money_height }}px;" data-index="{{ forloop.counter0 }}"&gt;
                &lt;span class="score-value"  style="color: #0a53be; position: absolute; top: -20px; width: 100%; text-align: center;"&gt;&gt;{{ value.score }}&lt;/span&gt;

                &lt;div class="money-earned" style="color: white; position: absolute; top: 10px; font-size: 8pt; bottom: 5px; width: 100%; text-align: center;"&gt;&gt;€{{ value.money }}&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        {% endfor %}
    &lt;/div&gt;
&lt;/div&gt;

&lt;form id="adjustmentForm" method="post"&gt;
    &lt;input type="hidden" id="adjustmentValues" name="adjustment_values" value=""&gt;
    &lt;button type="submit" id="submitButton" class="btn btn-primary" disabled&gt;Submit&lt;/button&gt;
&lt;/form&gt;
            </code></pre>
        </div>
    </div>

      <!-- Step 6: JavaScript Slider and Real-time Updates -->
    <div class="code-section">
       <div class="explanation">
    <h2>Step 6: Updating the Bar Graph in Real-Time (Javascript)</h2>
    <p>This JavaScript code handles updating the bar graph in real-time as the user
        interacts with the sliders. It calculates new heights for the bars based on the slope,
        curvature, and height values, and updates both the scores and the earnings shown
        for each player.</p>
           <p>Here you can also adjust the strength of the slope and curvature sliders if you would like them to be more or less sensitive. </p>
</div>
        <div class="code-snippet">
<pre class="language-java"><code class="language-java">

&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
    const bars = document.querySelectorAll('#interactiveHistogram .bar-graph');
    const heightSlider = document.getElementById('heightSlider');
    const slopeSlider = document.getElementById('slopeSlider');
    const curveSlider = document.getElementById('curveSlider');
    const adjustmentValues = document.getElementById('adjustmentValues');  // Hidden input to store money-earned values
    const submitButton = document.getElementById('submitButton');  // Standard submit button

    const maxScore = 15;
    const maxHeightPx = document.querySelector('#interactiveHistogram').clientHeight;

    // Flags to track whether each slider has been moved
    let heightMoved = false;
    let slopeMoved = false;
    let curveMoved = false;

    function updateBars() {
        const baseScore = parseInt(heightSlider.value);
        const slope = slopeSlider.value / 10;
        const curvature = curveSlider.value / 10;
        const numBars = bars.length;

        const moneyValues = [];

        bars.forEach((bar, index) =&gt; {
            const positionFactor = index / (numBars - 1);
            const curveFactor = Math.pow(positionFactor, 1 + curvature * 2);

            let newScore = baseScore + slope * positionFactor * maxScore * curveFactor;
            newScore = Math.max(0, Math.min(newScore, maxScore));
            newScore = Math.round(newScore);

            const newHeightPx = (newScore / maxScore) * maxHeightPx;
            bar.style.height = `${newHeightPx}px`;

            const scoreValue = bar.querySelector('.score-value');
            const moneyEarned = bar.querySelector('.money-earned');
            const moneyValue = (newScore / maxScore * 2.5).toFixed(2);

            scoreValue.innerText = newScore;
            moneyEarned.innerText = `€${moneyValue}`;

            // Add the money value to the array
            moneyValues.push(moneyValue);
        });

        // Store the money-earned values in the hidden input field
        adjustmentValues.value = moneyValues.join(',');
    }


            </code></pre>


        </div>
    </div>


      <!-- Step 7: JavaScript Slider and Real-time Updates -->
    <div class="code-section">
       <div class="explanation">
    <h2>Step 7: Enabling Submit and Safeguarding Form Submission  (Javascript)</h2>
    <p>This section adds additional functionality to the sliders. It enables the submit button once all sliders have been moved, and prevents the form from being submitted unless the sliders have been adjusted. The function ensures that the correct adjustments are applied before submission.</p>
</div>
        <div class="code-snippet">
<pre class="language-java"><code class="language-java">

    // Function to enable the submit button if all sliders have been moved
    function enableSubmitIfNeeded() {
        if (heightMoved && slopeMoved && curveMoved) {
            submitButton.disabled = false;  // Enable the submit button
        }
    }

    updateBars();

    // Mark sliders as "moved" when interacted with
    heightSlider.addEventListener('input', function() {
        heightMoved = true;
        updateBars();
        enableSubmitIfNeeded();
    });

    slopeSlider.addEventListener('input', function() {
        slopeMoved = true;
        updateBars();
        enableSubmitIfNeeded();
    });

    curveSlider.addEventListener('input', function() {
        curveMoved = true;
        updateBars();
        enableSubmitIfNeeded();
    });

    // Prevent form submission if all sliders haven't been moved (as an extra safeguard)
    document.getElementById('adjustmentForm').addEventListener('submit', function(event) {
        if (!heightMoved || !slopeMoved || !curveMoved) {
            event.preventDefault();
            alert("Please move all sliders before submitting.");
        }
    });
});

&lt;/script&gt;
            </code></pre>


        </div>
    </div>
</div>

   <div class="container">
<br>
    <center> <p style="font-size:25px">Thank you for reading this tutorial, if you have any questions, please don't hesitate to contact me. <br><br>  More tutorials:</p> </center>

   <div class="buttons">
                <a href="Blog_Taxation_Experiment.html" class="button">Interactive Taxation Vote</a>
            </div>

    </div>
    <br>

 <!-- Footer Section -->
    <footer>
        <div class="container">
            <p>&copy; 2024 Theo Saroglou | <a href="contact.html">Contact Me</a></p>
        </div>
    </footer>


<div class="university-logo">
        <img src="images/Logo_Universitat_de_Barcelona.png" alt="Universitat de Barcelona Logo">
    </div>
</body>